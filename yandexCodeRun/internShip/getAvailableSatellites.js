/* Доступность спутников

  Ограничение времени	1 секунда
  Ограничение памяти	64 Мб
  Ввод	input.txt
  Вывод	output.txt
  Вы работаете оператором в центре управления космическими аппаратами. Вам необходимо определить, какие из спутников в данный момент
  поддерживают связь. Каждый спутник проверяется специальной системой мониторинга, которая работает с переменной задержкой.
  Задача: написать функцию, которая принимает список спутников и возвращает названия только тех, которые в данный момент доступны
  для связи. Проверки должны выполняться максимально эффективно по времени. Спутник считается недоступным, если не отвечает или отвечает
  дольше 3000 мс.

  Напишите функцию getAvailableSatellites, которая будет возвращать массив станций, которые доступны. На вход функции подаётся массив
  объектов, состоящих из поля name и из поля check - функция, которая определяет, доступен ли этот спутник.

  Формат ввода

  [
    {
      name: "Первый",
      check: () => { Promise } 
    },
    {
      name: "Второй", 
      check: () => { Promise } 
    }
  ]

  Формат вывода
  ["Второй"]
  
*/

function getAvailableSatellites(satellites, timeoutMs = 3000) {
    
    const checkPromises = satellites.map(satellite => {
        
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Timeout')), timeoutMs)
        );
        
        return Promise.race([satellite.check(), timeoutPromise]);
    });    
    
    return Promise.allSettled(checkPromises).then(results => {
        const available = [];
        results.forEach((result, index) => {
            if (result.status === 'fulfilled' && result.value === true) {            
                available.push(satellites[index].name);
            }        
        });
        return available;
    });
}

/*module.exports = getAvailableSatellites;*/

/*  Задача состоит в том, чтобы написать функцию getAvailableSatellites, которая принимает массив спутников (каждый с полями name и check,
      где check — это асинхронная функция, возвращающая Promise) и возвращает массив имён только тех спутников, которые доступны.
      Спутник считается доступным, если его функция check() успешно завершается (resolve'ится) со значением true и делает это не дольше 3000 мс.
      Если check() не отвечает, отвечает с false или превышает таймаут, спутник считается недоступным.

    1. Определение функции и входных параметров.
    
    2. Создание промисов с таймаутом для каждого спутника.
          - для каждого спутника в массиве satellites создаётся новый Promise, который оборачивает проверку.
          - timeoutPromise: это Promise, который reject'ится через timeoutMs (3000 мс) с ошибкой 'Timeout'. Он используется для ограничения
            времени ожидания.
          - Promise.race([satellite.check(), timeoutPromise]). Promise.race возвращает Promise, который завершается (resolve или reject)
            как только один из переданных промисов завершится первым.
              - если satellite.check() resolve'ится (с true или false) быстрее 3000 мс, то race завершится с результатом check().
              - если satellite.check() reject'ится быстрее таймаута, race reject'ится с ошибкой от check().
              - если ни то, ни другое не случится в течение 3000 мс, то race reject'ится с ошибкой 'Timeout'.
          - результат: checkPromises — это массив новых Promise'ов (по одному на спутник), каждый из которых либо resolve'ится
            со значением от check(), либо reject'ится (из-за таймаута или ошибки в check()).
          Это обеспечивает, что проверки выполняются параллельно (не последовательно), что максимально эффективно по времени — все
          спутники проверяются одновременно, а не один за другим.

    3. Ожидание завершения всех проверок.
          - Promise.allSettled(checkPromises): эта функция ждёт, пока все Promise'ы в массиве checkPromises завершатся
          (независимо от того, resolve или reject). Она возвращает массив результатов, где каждый результат — объект с полями
          status ('fulfilled' или 'rejected') и value (для fulfilled) или reason (для rejected).
          - в отличие от Promise.all, allSettled не останавливается на первом reject — она ждёт все проверки, что идеально для нашей
          задачи (мы хотим проверить всех спутников, даже если некоторые недоступны).
          - .then(results => { ... }): здесь обрабатываются результаты. results — массив объектов, соответствующий checkPromises.

    4. Фильтрация доступных спутников 
          - инициализируется пустой массив available для имён доступных спутников.
          - перебираются результаты (results) с индексом (index).
          - для каждого результата: 
            - если result.status === 'fulfilled' (т.е. Promise завершился успешно, без таймаута или ошибки)
              И result.value === true (т.е. check() вернул true), то спутник доступен — его имя добавляется в available.
            - если статус 'rejected' (таймаут или ошибка в check()) или value не true, спутник пропускается.
          - возвращается массив available с именами доступных спутников.
*/